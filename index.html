<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imanes Tur√≠sticos AR</title>
    
    <!-- Archivos locales con fallback a CDN -->
    <script src="aframe.min.js"></script>
    <script src="mindar-image-aframe.prod.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            width: 100%;
            height: 100%;
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: fixed;
        }

        /* PANTALLA DE CARGA */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, #FF9800, #FF5722);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        .title {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #FF9800;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 30px;
            max-width: 300px;
            line-height: 1.5;
        }

        .progress-container {
            width: 80%;
            max-width: 300px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00C853, #64DD17);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            margin: 10px 0;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .start-btn {
            background: linear-gradient(45deg, #FF9800, #FF5722);
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            display: none;
        }

        /* ESCENA AR */
        #ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        /* CONTROLES */
        #controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: none;
            justify-content: center;
            gap: 15px;
            z-index: 999;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(33, 150, 243, 0.9);
            border: 2px solid white;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            border: 2px solid white;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            z-index: 999;
            align-items: center;
            justify-content: center;
        }

        #status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            display: none;
            z-index: 999;
            text-align: center;
            max-width: 80%;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .error {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .retry-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- PANTALLA DE CARGA -->
    <div id="loading-screen">
        <div class="logo">ü¶ú</div>
        <h1 class="title">IMANES TUR√çSTICOS AR</h1>
        <p class="subtitle">Escanea tu im√°n para ver contenido en Realidad Aumentada</p>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="progress-text" id="progressText">Iniciando...</div>
        
        <button class="start-btn" id="startBtn">INICIAR EXPERIENCIA</button>
        
        <div class="error" id="errorMsg"></div>
        <button class="retry-btn" id="retryBtn">REINTENTAR</button>
    </div>

    <!-- ESCENA AR -->
    <div id="ar-scene"></div>

    <!-- CONTROLES -->
    <button id="exit-btn">‚úï</button>
    <div id="controls">
        <button class="control-btn" id="soundBtn">üîä</button>
        <button class="control-btn" id="infoBtn">‚ùì</button>
        <button class="control-btn" id="replayBtn">‚Ü∫</button>
    </div>
    
    <!-- ESTADO -->
    <div id="status">Buscando im√°n...</div>

    <script>
        // Estado de la aplicaci√≥n
        const state = {
            loaded: false,
            arActive: false,
            soundOn: false,
            currentStage: 0,
            video: null
        };

        // Elementos del DOM
        const elements = {
            loading: document.getElementById('loading-screen'),
            scene: document.getElementById('ar-scene'),
            startBtn: document.getElementById('startBtn'),
            exitBtn: document.getElementById('exit-btn'),
            controls: document.getElementById('controls'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            errorMsg: document.getElementById('errorMsg'),
            retryBtn: document.getElementById('retryBtn'),
            soundBtn: document.getElementById('soundBtn'),
            infoBtn: document.getElementById('infoBtn'),
            replayBtn: document.getElementById('replayBtn')
        };

        // Mensajes de progreso
        const progressMessages = [
            { text: "Verificando recursos...", progress: 10 },
            { text: "Cargando A-Frame...", progress: 20 },
            { text: "Cargando MindAR...", progress: 40 },
            { text: "Preparando c√°mara...", progress: 60 },
            { text: "Configurando escena...", progress: 80 },
            { text: "¬°Listo para comenzar!", progress: 100 }
        ];

        // Actualizar progreso
        function updateProgress(step) {
            const msg = progressMessages[step];
            if (msg) {
                elements.progressBar.style.width = `${msg.progress}%`;
                elements.progressText.textContent = msg.text;
                
                if (msg.progress === 100) {
                    setTimeout(() => {
                        elements.startBtn.style.display = 'block';
                    }, 500);
                }
            }
        }

        // Verificar recursos
        async function checkResources() {
            const resources = [
                { name: 'A-Frame', check: () => typeof AFRAME !== 'undefined' },
                { name: 'MindAR', check: () => typeof MINDAR !== 'undefined' },
                { name: 'Marcador', url: 'marker.mind' },
                { name: 'Video', url: 'asset.mp4' }
            ];
            
            for (let i = 0; i < resources.length; i++) {
                const resource = resources[i];
                updateProgress(i);
                
                try {
                    if (resource.check) {
                        if (!resource.check()) {
                            throw new Error(`${resource.name} no cargado`);
                        }
                    } else if (resource.url) {
                        const response = await fetch(resource.url, { method: 'HEAD' });
                        if (!response.ok) throw new Error(`${resource.name} no encontrado`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (error) {
                    showError(`Error: ${error.message}`);
                    return false;
                }
            }
            
            return true;
        }

        // Mostrar error
        function showError(message) {
            elements.errorMsg.textContent = message;
            elements.errorMsg.style.display = 'block';
            elements.retryBtn.style.display = 'block';
            elements.progressText.textContent = 'Error encontrado';
        }

        // Inicializar
        async function initialize() {
            elements.retryBtn.style.display = 'none';
            elements.errorMsg.style.display = 'none';
            
            const resourcesOk = await checkResources();
            if (resourcesOk) {
                state.loaded = true;
            }
        }

        // Crear escena AR
        function createARScene() {
            elements.scene.innerHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: marker.mind; autoStart: true;"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    renderer="colorManagement: true; alpha: true;"
                    embedded
                >
                    <a-assets>
                        <video id="ar-video" src="asset.mp4" preload="auto" loop muted playsinline></video>
                    </a-assets>
                    
                    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
                    
                    <a-entity mindar-image-target="targetIndex: 0">
                        <a-plane 
                            src="#ar-video"
                            width="1.6"
                            height="0.9"
                            position="0 0 0"
                            rotation="0 0 0"
                            material="shader: flat; transparent: true;"
                        ></a-plane>
                    </a-entity>
                </a-scene>
            `;
            
            elements.scene.style.display = 'block';
            
            // Configurar eventos despu√©s de que la escena se cargue
            setTimeout(setupSceneEvents, 1000);
        }

        // Configurar eventos de la escena
        function setupSceneEvents() {
            const scene = document.querySelector('a-scene');
            
            if (!scene) {
                console.error('Escena no encontrada');
                return;
            }
            
            scene.addEventListener('loaded', () => {
                console.log('Escena AR cargada');
                
                // Obtener el video
                state.video = document.querySelector('#ar-video');
                
                // Configurar eventos del target
                const target = document.querySelector('[mindar-image-target]');
                if (target) {
                    target.addEventListener('targetFound', () => {
                        console.log('Marcador encontrado');
                        elements.status.textContent = '‚úÖ Marcador detectado';
                        elements.status.style.background = 'rgba(76, 175, 80, 0.7)';
                        
                        if (state.video) {
                            state.video.play().catch(e => {
                                console.log('Autoplay bloqueado, intentando con mute');
                                state.video.muted = true;
                                state.video.play();
                            });
                        }
                    });
                    
                    target.addEventListener('targetLost', () => {
                        console.log('Marcador perdido');
                        elements.status.textContent = 'üîç Buscando im√°n...';
                        elements.status.style.background = 'rgba(255, 152, 0, 0.7)';
                        
                        if (state.video) {
                            state.video.pause();
                        }
                    });
                }
                
                // Mostrar controles
                setTimeout(() => {
                    elements.exitBtn.style.display = 'flex';
                    elements.controls.style.display = 'flex';
                    elements.status.style.display = 'block';
                    state.arActive = true;
                }, 500);
            });
            
            scene.addEventListener('error', (e) => {
                console.error('Error en escena AR:', e.detail);
                showError('Error al cargar la realidad aumentada');
            });
        }

        // Iniciar experiencia AR
        function startAR() {
            if (!state.loaded) {
                showError('La aplicaci√≥n no se carg√≥ correctamente');
                return;
            }
            
            elements.loading.style.display = 'none';
            createARScene();
        }

        // Salir de AR
        function exitAR() {
            if (state.video) {
                state.video.pause();
                state.video.currentTime = 0;
            }
            
            // Limpiar escena
            elements.scene.innerHTML = '';
            elements.scene.style.display = 'none';
            
            // Ocultar controles
            elements.exitBtn.style.display = 'none';
            elements.controls.style.display = 'none';
            elements.status.style.display = 'none';
            
            // Mostrar pantalla de carga
            elements.loading.style.display = 'flex';
            elements.startBtn.style.display = 'block';
            state.arActive = false;
            state.soundOn = false;
            state.currentStage = 0;
            
            // Resetear progreso
            elements.progressBar.style.width = '100%';
            elements.progressText.textContent = '¬°Listo para comenzar!';
        }

        // Configurar controles
        function setupControls() {
            // Bot√≥n de inicio
            elements.startBtn.addEventListener('click', startAR);
            
            // Bot√≥n de salir
            elements.exitBtn.addEventListener('click', exitAR);
            
            // Bot√≥n de sonido
            elements.soundBtn.addEventListener('click', () => {
                state.soundOn = !state.soundOn;
                if (state.video) {
                    state.video.muted = !state.soundOn;
                }
                elements.soundBtn.textContent = state.soundOn ? 'üîä' : 'üîá';
                elements.soundBtn.style.background = state.soundOn ? 
                    'rgba(76, 175, 80, 0.9)' : 'rgba(33, 150, 243, 0.9)';
            });
            
            // Bot√≥n de informaci√≥n
            elements.infoBtn.addEventListener('click', () => {
                alert('Instrucciones:\n\n1. Aseg√∫rate de tener buena iluminaci√≥n\n2. Apunta la c√°mara al im√°n\n3. Mant√©n el dispositivo estable\n4. El video aparecer√° autom√°ticamente');
            });
            
            // Bot√≥n de repetir
            elements.replayBtn.addEventListener('click', () => {
                if (state.video) {
                    state.video.currentTime = 0;
                    state.video.play();
                }
            });
            
            // Bot√≥n de reintento
            elements.retryBtn.addEventListener('click', initialize);
            
            // Tecla Escape para salir
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && state.arActive) {
                    exitAR();
                }
            });
        }

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Aplicaci√≥n iniciada');
            setupControls();
            initialize();
        });
    </script>
</body>
</html>
